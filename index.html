<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>HUB UNO — UNIFICADO • HDPro</title>
  <meta name="theme-color" content="#0b0f14" />
  <!-- HDPro: overlay unificado (sempre ON), stack/grupos completos, vozes & presets, LS Panel escopado, self-test dentro do LS Panel -->
  <style>
    :root {
      --grad-a:#ff52e5; --grad-b:#00c5e5; --fg:#eaf2ff; --mut:rgba(234,242,255,.68);
      --surface:rgba(15,17,32,.58); --surface-strong:rgba(15,17,32,.92);
      --bd:1px solid rgba(255,255,255,.12); --r:14px; --r2:20px; --shadow:0 14px 40px rgba(0,0,0,.45);
      --tabsH:74px; --hdrH:64px; --blur:20px; --ease:cubic-bezier(.22,.61,.36,1);
    }
    html,body{height:100%;max-width:100%;overflow-x:hidden}
    *{box-sizing:border-box}
    body{margin:0;color:var(--fg);background:linear-gradient(42deg,var(--grad-a),var(--grad-b)) fixed;font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;position:relative}
  </style>
  <style id="overlay-unificado">
    :root{--arch-color:#8a2be2;--arch-overlay-strength:12%;--arch-overlay:color-mix(in srgb,var(--arch-color) var(--arch-overlay-strength),transparent)}
    body::after{content:"";position:fixed;inset:0;z-index:0;background:var(--arch-overlay,transparent)!important;pointer-events:none}
    #arch-fadeCover{background:var(--arch-overlay,transparent);z-index:2}
  </style>
  <style>
    .fx-trans{transition:transform .16s var(--ease), background .25s var(--ease), box-shadow .25s var(--ease), border-color .25s var(--ease), color .25s var(--ease), opacity .25s var(--ease)}
    .fx-press:active{transform:translateY(0) scale(.98)}
    .btn,.ib{background:var(--surface);border:var(--bd);color:var(--fg);font-weight:800;border-radius:12px;cursor:pointer;position:relative}
    .btn{padding:.58rem .9rem;background:linear-gradient(180deg,#11162a,#0b1122)}
    .btn.prime{background:linear-gradient(90deg,#a66fff,#6db4ff);color:#0b0f14;border-color:transparent}
    header.mast{position:fixed;left:0;right:0;top:0;height:var(--hdrH);z-index:100;display:flex;align-items:center;gap:10px;padding:0 12px;background:linear-gradient(180deg,rgba(0,0,0,.28),rgba(0,0,0,0));backdrop-filter:blur(var(--blur))}
    .ib{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;box-shadow:var(--shadow)}
    .title{flex:1;text-align:center;line-height:1}
    .title h1{margin:0;font-size:18px;letter-spacing:.06em;font-weight:900}
    .title small{display:block;color:var(--mut);letter-spacing:.1em}

    main{position:relative;height:100%;padding-top:calc(var(--hdrH) + env(safe-area-inset-top));padding-bottom:calc(var(--tabsH)+env(safe-area-inset-bottom));overflow:hidden}
    .view{position:absolute;inset:0;padding:12px 14px;overflow:auto;display:none}
    .view.active{display:block;animation:fade .4s var(--ease)}
    @keyframes fade{0%{opacity:0;transform:scale(.995)}100%{opacity:1;transform:scale(1)}}

    .grid{display:grid;gap:12px;max-width:980px;margin:0 auto}
    .card{background:var(--surface);border:var(--bd);border-radius:var(--r2);box-shadow:var(--shadow);padding:12px}
    .mut{color:var(--mut);font-size:12px}

    .arch-container{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:4vh}
    .arch-switcher{display:flex;gap:6px;align-items:center;background:rgba(15,17,32,.7);border:var(--bd);border-radius:999px;padding:4px 8px;backdrop-filter:blur(8px)}
    .arch-switcher select{appearance:none;background:rgba(255,255,255,.06);color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px 8px;font-size:12px}
    .arch-switcher button{width:30px;height:30px;padding:0;border-radius:8px}
    .arch-circle{position:relative;width:min(82vw,560px);aspect-ratio:1/1;border-radius:50%;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:radial-gradient(60% 60% at 50% 50%, rgba(0,255,255,.08), rgba(255,255,255,.02));box-shadow:var(--shadow)}
    .arch-circle iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:#0b0f14}
    #arch-fadeCover{position:absolute;inset:0;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #arch-fadeCover.show{opacity:1}
    .arch-msg{margin-top:8px;padding:6px 10px;border-radius:12px;background:rgba(15,17,32,.72);color:var(--fg);font-size:13px;max-width:90%;text-align:center;opacity:0;transition:opacity .3s ease}
    .arch-msg.show{opacity:1}

    nav.tabbar{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom,0);height:var(--tabsH);z-index:1500;display:flex;justify-content:center;padding:6px 14px}
    .tabbar .inner{width:100%;max-width:980px;display:flex;justify-content:space-around;align-items:center;background:var(--surface);border:var(--bd);border-radius:22px;box-shadow:var(--shadow);padding:10px 14px}
    .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--mut);font-size:11px;font-weight:800;padding:8px;border-radius:14px;cursor:pointer}
    .tab:hover{background:rgba(255,255,255,.06)}.tab.active{color:var(--fg);background:rgba(255,255,255,.10);box-shadow:0 0 0 2px rgba(255,255,255,.10)}

    /* Splash */
    #appSplash{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(42deg,var(--grad-a),var(--grad-b));z-index:200;opacity:1;visibility:visible;transition:opacity .3s var(--ease), visibility 0s linear .3s}
    #appSplash.hidden{opacity:0;visibility:hidden}
    #appSplash::before,#appSplash::after{content:"";position:absolute;width:420px;height:420px;border-radius:50%;filter:blur(100px);opacity:.35;pointer-events:none}
    #appSplash::before{background:var(--grad-a);top:-180px;left:-120px} #appSplash::after{background:var(--grad-b);bottom:-180px;right:-120px}
    .di{--di-size:40px;--di-stroke:2px;position:relative;width:var(--di-size);height:var(--di-size)}
    .di .ring{position:absolute;inset:0;border:var(--di-stroke) solid rgba(255,255,255,.35);border-radius:50%;animation:spin6 6s linear infinite}
    .di .stroke{position:absolute;left:50%;top:50%;width:62%;height:var(--di-stroke);background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transform:translate(-50%,-50%);border-radius:999px;animation:breathe 2.4s ease-in-out infinite}
    .di .dots{position:absolute;inset:0;transform:rotate(-90deg);animation:orbit 4.2s linear infinite}
    .di .dots i{--i:0;position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;background:conic-gradient(var(--grad-a),var(--grad-b));opacity:.85;transform:rotate(calc(var(--i)*51deg)) translate(calc(7px + var(--i)*2.2px)) rotate(calc(var(--i)*-51deg));animation:pulse 4.2s linear infinite;animation-delay:calc(var(--i)*.6s)}
    @keyframes orbit{to{transform:rotate(270deg)}}@keyframes spin6{to{transform:rotate(360deg)}}@keyframes breathe{0%,100%{opacity:.9}50%{opacity:1}}@keyframes pulse{0%,70%{opacity:.55;transform:scale(.92)}76%,84%{opacity:1;transform:scale(1.12)}100%{opacity:.7;transform:scale(.96)}}
    #appSplash .loading-text{margin-top:16px;font-size:15px;font-weight:800;letter-spacing:.04em;color:#f8f9fc;animation:fadeUp 2.4s ease-in-out infinite}
    @keyframes fadeUp{0%,20%{opacity:0;transform:translateY(12px)}40%,60%{opacity:1;transform:translateY(0)}80%,100%{opacity:0;transform:translateY(-12px)}}

    /* Stack */
    #stackWrap{display:grid;gap:12px}
    .session{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:var(--bd);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .session .hdr{display:flex;align-items:center;gap:8px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-bottom:1px solid #ffffff18}
    .session .title{font-weight:850;max-width:56vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .session .tools{margin-left:auto;display:flex;gap:6px}
    .session iframe{display:block;width:100%;height:60vh;border:0;background:#000}
    .session.min iframe{display:none}
    .session.full{position:fixed!important;inset:0;z-index:1000;margin:0;width:100%;height:100%;display:flex;flex-direction:column}
    .session.full iframe{flex:1 1 auto!important;height:100%!important}
    .stack-group{border:var(--bd);border-radius:var(--r);overflow:hidden}
    .stack-group summary{background:var(--surface);padding:8px 12px;font-weight:800;cursor:pointer;list-style:none;display:flex;align-items:center;justify-content:space-between}
    .stack-group summary::-webkit-details-marker{display:none}
    .stack-group .group-content{padding:8px 12px}

    #dock{position:fixed;left:10px;right:10px;bottom:calc(var(--tabsH) + 8px + env(safe-area-inset-bottom));display:flex;gap:8px;flex-wrap:wrap;z-index:80}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:.38rem .65rem;border:1px solid #ffffff18;background:#0f1428;border-radius:999px;font-weight:800}
  </style>
  <style id="theme-blue1">
  body[data-theme="blue1"]{
    --grad-a:#0b1e3b; --grad-b:#113a7b; --fg:#e8f0ff; --mut:rgba(232,240,255,.68);
    --surface:rgba(10,16,28,.55); --surface-strong:rgba(10,16,28,.88);
    --bd:1px solid rgba(126,170,255,.16);
  }
  </style>
  <style id="audio-meter-css">
  .arch-circle .audio-meter{position:absolute;right:8px;top:8px;width:26px;height:26px;border-radius:50%;border:1px solid rgba(255,255,255,.2);background:rgba(15,17,32,.55);display:grid;place-items:center;z-index:6;cursor:pointer}
  .arch-circle .audio-meter .bar{width:6px;height:20%;border-radius:3px;background:linear-gradient(180deg,var(--grad-a),var(--grad-b));transition:height .08s linear}
  .arch-circle .audio-meter.on{box-shadow:0 0 0 2px rgba(57,255,182,.25)}
  </style>
  
  <!-- OVERLAY: background-only patch (sobrepõe body::after e usa bg do body) -->
  <style id="OVERLAY_BG_ONLY">
  /* 1) Neutraliza o pseudo-elemento antigo para não cobrir conteúdo */
  body::after{ content: none !important; }
  /* 2) Layer do overlay no BACKGROUND do body (atrás de tudo)  */
  /*    Layer 1 = overlay (controlado por --arch-overlay)
        Layer 2 = gradiente base (Nebula/Blue)                          */
  body{
    background:
      radial-gradient(120% 120% at 50% 40%,
        var(--arch-overlay, rgba(0,0,0,0)) 0%,
        rgba(0,0,0,0) 62%),
      linear-gradient(42deg, var(--grad-a), var(--grad-b)) fixed !important;
  }
  </style>

  <!-- 3) Overlay ON por padrão (substituído quando o arquétipo troca a cor) -->
  <script id="OVERLAY_DEFAULT_BOOT">
  try { document.documentElement.style.setProperty('--arch-overlay', 'rgba(64,158,255,.22)'); } catch {}
  </script>
  
  <!-- UI GLOW PATCH: Nav & Tabs & Chat & Stack (visual upgrade) -->
  <style id="UI_GLOW_PATCH">
  /* Nav tabs: vidro + glow + micro-motion */
  nav.tabbar .inner{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(12px) saturate(140%);box-shadow:0 12px 34px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.06) inset}
  .tabbar .tab{position:relative;transition:transform .12s var(--ease), box-shadow .18s var(--ease), background .18s var(--ease)}
  .tabbar .tab::after{content:"";position:absolute;inset:auto 14px 4px 14px;height:2px;border-radius:2px;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));opacity:0;transition:opacity .18s var(--ease)}
  .tabbar .tab:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
  .tabbar .tab.active{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));box-shadow:0 0 0 2px rgba(255,255,255,.14)}
  .tabbar .tab.active::after{opacity:.9}

  /* Stack: header das sessões + botões */
  .session .hdr{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.02));border-bottom:1px solid rgba(255,255,255,.16)}
  .session .tools .btn{min-width:36px;min-height:32px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.16)}
  .session .tools .btn:hover{box-shadow:0 10px 22px rgba(0,0,0,.45),0 0 0 1px rgba(255,255,255,.16) inset}
  .group-select.btn{min-height:32px;border-radius:10px}

  /* Chat: bolhas melhoradas */
  #chatFeed .msg.user{background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));box-shadow:0 4px 14px rgba(0,0,0,.35)}
  #chatFeed .msg.ai{background:linear-gradient(180deg, rgba(57,255,182,.18), rgba(57,255,182,.08));box-shadow:0 4px 14px rgba(0,0,0,.35)}

  /* Apps quick buttons: leve neon */
  #appsQuickBtns .btn{border:1px solid rgba(255,255,255,.16);background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.02))}
  #appsQuickBtns .btn:hover{box-shadow:0 0 0 2px rgba(255,255,255,.18)}
  </style>

  <!-- LS PANEL OVERRIDE (CSS) -->
  <style id="LSPANEL_OVERRIDE_CSS">
  #lsModal .panel{background:linear-gradient(180deg,rgba(15,17,32,.96),rgba(15,17,32,.90));border:1px solid rgba(255,255,255,.12)}
  #lsToolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
  #lsSearch{min-height:42px;border-radius:12px;padding:8px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:var(--fg);flex:1}
  #lsSort{min-height:42px;border-radius:12px;padding:8px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:var(--fg)}
  .ls-chip{min-height:34px;border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:var(--fg);font-weight:800;cursor:pointer}
  .ls-chip.on{background:rgba(57,255,182,.20);border-color:rgba(57,255,182,.45)}
  .ls-copy,.ls-disable{min-height:30px;border-radius:10px;padding:4px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);color:var(--fg);font-size:12px;cursor:pointer}
  .ls-item-highlight{outline:1px solid rgba(57,255,182,.45);box-shadow:0 0 0 2px rgba(57,255,182,.18) inset}
  #lsDevPanel{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:14px;background:rgba(255,255,255,.04);padding:10px}
  #lsDevPanel .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  #lsDevPanel .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);font:12px/1.2 ui-monospace,monospace}
</style>
</head>
<body>
  <!-- Splash -->
  <div id="appSplash" role="status" aria-live="polite" aria-busy="true">
    <div class="di"><i class="ring"></i><i class="stroke"></i><div class="dots"><i style="--i:0"></i><i style="--i:1"></i><i style="--i:2"></i><i style="--i:3"></i><i style="--i:4"></i></div></div>
    <div class="loading-text">Carregando UNO…</div>
  </div>

  <!-- Header -->
  <header class="mast">
    <button class="ib fx-trans fx-press" id="btnBack" title="Voltar" aria-label="Voltar">⟵</button>
    <div class="title"><h1>HUB UNO</h1><small>Unificado • HDPro</small></div>
    <button class="ib fx-trans fx-press" id="btnDownload" title="Baixar HTML">⇩</button>
    <button class="ib fx-trans fx-press" id="btnHelp" title="Ajuda">?</button>
    <button class="ib fx-trans fx-press" id="btnLS" title="Local Storage">⚙️</button>
  </header>

  <main>
    <!-- HOME -->
    <section id="v-home" class="view active">
      <div class="grid">
        <div class="arch-container">
          <div class="arch-switcher">
            <button class="btn fx-trans fx-press" id="arch-prev" title="Anterior">◀</button>
            <select id="arch-select" title="Escolher arquétipo">
              <option value="atlas.html">atlas.html</option>
              <option value="nova.html">nova.html</option>
              <option value="vitalis.html">vitalis.html</option>
              <option value="pulse.html">pulse.html</option>
              <option value="artemis.html">artemis.html</option>
              <option value="serena.html">serena.html</option>
              <option value="kaos.html">kaos.html</option>
              <option value="genus.html">genus.html</option>
              <option value="lumine.html">lumine.html</option>
              <option value="rhea.html">rhea.html</option>
              <option value="solus.html">solus.html</option>
              <option value="aion.html">aion.html</option>
            </select>
            <button class="btn fx-trans fx-press" id="arch-next" title="Próximo">▶</button>
          </div>
          <div class="arch-circle">
            <div id="audioMeter" class="audio-meter" title="Áudio (toque p/ ligar/desligar)"><span class="bar"></span></div>
            <div id="arch-fadeCover"></div>
            <iframe id="arch-frame" title="Archetype Core" sandbox="allow-scripts" referrerpolicy="no-referrer" src="./archetypes/atlas.html"></iframe>
          </div>
          <div id="archMsg" class="arch-msg">Bem‑vindo de volta. UNO está ao seu lado.</div>
        </div>
        <div class="card"><strong>Status</strong><div class="mut">Selecione um arquétipo e comece.</div></div>
      </div>
    </section>

    <!-- APPS -->
    <section id="v-apps" class="view">
      <div class="grid">
        <div class="card"><strong>Apps</strong><div class="mut">Catálogo enxuto — plugue seu JSON se precisar.</div></div>

        <!-- Chat rápido (Apps) -->
        <div class="card" id="appsChatCard">
          <div style="font-weight:800;margin-bottom:6px">Chat rápido</div>
          <form id="appsChatForm" style="display:flex;gap:8px;align-items:center">
            <input id="appsChatInput" class="btn" placeholder="Escreva aqui…" style="flex:1;min-height:44px" />
            <button id="appsChatSend" class="btn prime" type="submit">Enviar</button>
            <button id="appsVoiceBtn" class="btn" type="button" title="Falar">🎤</button>
          </form>
          <div class="mut" style="margin-top:6px">As mensagens entram no feed do Chat.</div>
        </div>

        <!-- Descarregador de Segurança -->
        <div class="card" id="safeUnloadCard">
          <div style="font-weight:800;margin-bottom:6px">Descarregador de Segurança</div>
          <div class="mut">Encerra streams/áudio, descarrega iframes, cancela síntese de voz, fecha sessões e tenta desregistrar service workers.</div>
          <div style="margin-top:8px"><button id="btnUnloadSafe" class="btn">Descarregar agora</button></div>
        </div>
      </div>

      <!-- Botões flutuantes (Apps) -->
      <div id="appsQuickBtns" style="position:fixed;right:14px;bottom:calc(var(--tabsH) + 30px + env(safe-area-inset-bottom,0));display:flex;flex-direction:column;gap:10px;z-index:97">
        <button id="appsQuickText" class="btn" title="Enviar texto" style="width:42px;height:42px;border-radius:21px">✍️</button>
        <button id="appsQuickVoice" class="btn" title="Falar" style="width:42px;height:42px;border-radius:21px">🎙️</button>
      </div>
    </section>

    <!-- STACK (HDPro) -->
    <section id="v-stack" class="view">
      <div class="grid">
        <div class="card" style="display:block">
          <div style="font-weight:800;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            Sessões
            <button id="btnCloseAll" class="btn fx-trans fx-press" title="Fechar todas">Fechar todas</button>
            <button id="btnAddGroup" class="btn fx-trans fx-press" title="Novo grupo">Novo grupo</button>
            <button id="btnRenameGroup" class="btn fx-trans fx-press" title="Renomear grupo">Renomear grupo</button>
            <button id="btnStackUpload" class="btn fx-trans fx-press" title="Upload HTML">Upload HTML</button>
            <input id="stackUpload" type="file" accept=".html,text/html" style="display:none" />
          </div>
          <div class="mut">Reabra rápido pelo dock abaixo.</div>
        </div>
        <div id="stackWrap" class="grid"></div>
      </div>
    </section>

    <!-- BRAIN (vozes & presets) -->
    <section id="v-brain" class="view">
      <div class="grid">
        <div class="card" style="display:block">
          <div style="font-weight:800">Usuário</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="userName" class="btn" placeholder="Seu nome" />
            <button id="saveName" class="btn prime">Salvar</button>
          </div>
        </div>

        <div class="card" style="display:block">
          <div style="font-weight:800">Voz do assistente (global)</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="selectVoice" class="btn" style="max-width:260px"><option>Carregando vozes…</option></select>
            <button id="saveVoice" class="btn">Salvar</button>
            <button id="testVoice" class="btn">Testar</button>
          </div>
        </div>

        <div class="card" style="display:block">
          <div style="font-weight:800;margin-bottom:6px">Vozes por Arquétipo</div>
          <div id="voicesWrap" style="display:grid;gap:10px"></div>
        </div>

        <div class="card" style="display:block">
          <div style="font-weight:800">Presets Visuais (orb)</div>
          <div style="display:grid;gap:10px">
            <label style="display:flex;align-items:center;gap:8px">
              <span>Preset:</span>
              <select id="visualPreset" class="btn" style="max-width:220px">
                <option value="blue1">Blue‑1 (shader)</option>
                <option value="strong">Strong</option>
                <option value="cinematic-soft">Cinematic Soft</option>
              </select>
            </label>
            <label style="display:flex;align-items:center;gap:8px">
              <input id="bloomToggle" type="checkbox" /> Bloom fotográfico
            </label>
            <label style="display:flex;align-items:center;gap:8px">
              <span>Glow:</span>
              <input id="glowRange" type="range" min="0" max="1" step="0.05" style="flex:1" />
              <span id="glowVal" class="mut" style="width:42px;text-align:right">0.80</span>
            </label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="applyVisual" class="btn prime">Aplicar</button>
              <button id="resetVisual" class="btn">Padrão</button>
            </div>
            <div class="mut">As preferências são salvas no seu navegador e enviadas ao arquétipo ativo.</div>
          </div>
        </div>
      </div>
      <div class="card" style="display:block">
          <div style="font-weight:800">Tema da UI</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap">
            <select id="uiThemeSelect" class="btn" style="max-width:220px">
              <option value="default">Padrão (colorido)</option>
              <option value="blue1">Blue‑1 (UI)</option>
            </select>
            <span class="mut">Aplica o tema em toda a interface (não só no orb).</span>
          </div>
        </div>
    </section>
    <!-- CHAT -->
    <section id="v-chat" class="view"><div id="chatFeed" class="card"><div class="msg ai">Oi! Pronto pra conversar.</div></div></section>
  </main>

  <div id="dock"></div>

  <nav class="tabbar">
    <div class="inner">
      <button class="tab fx-trans fx-press active" data-nav="home">🏠</button>
      <button class="tab fx-trans fx-press" data-nav="apps">📁</button>
      <button class="tab fx-trans fx-press" data-nav="stack">🗂️</button>
      <button class="tab fx-trans fx-press" data-nav="brain">🧠</button>
      <button class="tab fx-trans fx-press" data-nav="chat">💬</button>
    </div>
  </nav>

  <!-- LS Panel Modal (com Self‑test) -->
  <div id="lsModal" aria-hidden="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1600;background:rgba(0,0,0,.55);backdrop-filter:blur(8px)">
    <div class="panel" style="width:min(1080px,96vw);max-height:86vh;overflow:auto;background:var(--surface-strong);border:var(--bd);border-radius:16px;box-shadow:var(--shadow);padding:14px">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,.12);padding-bottom:8px">
        <div style="font-weight:900;letter-spacing:.06em">LocalStorage • Painel</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="lsRescan" class="btn">Re-scan</button>
          <button id="lsExport" class="btn">Exportar</button>
          <label for="lsImportFile" class="btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">Importar</label>
          <input id="lsImportFile" type="file" accept="application/json" hidden />
          <button id="lsClearAll" class="btn">Limpar (Infodose)</button>
          <button id="lsClose" class="btn">Fechar</button>
        </div>
      </div>
      <div id="lsMeta" class="mut" style="margin-bottom:8px">—</div>
      <div id="lsList" style="display:grid;grid-template-columns:1fr;gap:8px"></div>
      <div class="card" style="margin-top:10px">
        <div style="font-weight:800;display:flex;align-items:center;justify-content:space-between;gap:8px">
          <span>Self‑test (HDPro)</span>
          <button id="runSelfTest" class="btn">Executar</button>
        </div>
        <div id="selfLog" style="font:12px/1.45 ui-monospace,monospace;margin-top:8px;white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <script>
  /* ===== Helpers ===== */
  const $ = (q, r=document)=>r.querySelector(q); const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
  const LS = { get:(k,d)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):d }catch{ return d } }, set:(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }, raw:k=>localStorage.getItem(k)||'' };

  /* ===== Navegação / Header ===== */
  function nav(key){ ['home','apps','stack','brain','chat'].forEach(k=>{ $('#v-'+k)?.classList.toggle('active',k===key); document.querySelector(`.tab[data-nav="${k}"]`)?.classList.toggle('active',k===key); }); try{ localStorage.setItem('uno:lastTab',key) }catch{} }
  $$('.tab,[data-nav]').forEach(b=> b.addEventListener('click',()=>nav(b.dataset.nav||'home')));
  $('#btnBack').onclick=()=>{ try{ history.length>1&&history.back() }catch{} };
  $('#btnHelp').onclick=()=>{ alert('Atalhos: g+h Home, g+a Apps, g+s Stack, g+b Brain, g+r Chat, Ctrl/Cmd+S exporta HTML.'); };
  function downloadSelf(){ try{ const html='<!doctype html>\n'+document.documentElement.outerHTML; const blob=new Blob([html],{type:'text/html;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='HUB-UNO-UNIFICADO-HDPro.html'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);}catch(e){alert('Falha ao exportar: '+e.message);} }
  $('#btnDownload').onclick=downloadSelf;

  /* ===== Archetypes / Overlay (sempre ON) ===== */
  const ARCH_LIST=['atlas','nova','vitalis','pulse','artemis','serena','kaos','genus','lumine','rhea','solus','aion'];
  const OVER={ atlas:'rgba(64,158,255,.22)', nova:'rgba(255,82,177,.22)', vitalis:'rgba(72,218,168,.22)', pulse:'rgba(0,191,255,.22)', artemis:'rgba(186,130,219,.22)', serena:'rgba(140,190,255,.22)', kaos:'rgba(255,77,109,.22)', genus:'rgba(87,207,112,.22)', lumine:'rgba(255,213,79,.22)', rhea:'rgba(0,209,178,.22)', solus:'rgba(100,149,237,.22)', aion:'rgba(255,159,67,.22)', default:'rgba(255,255,255,0)' };
  function forceOverlay(base){ const c=OVER[base]||OVER.default; document.documentElement.style.setProperty('--arch-overlay', c); document.documentElement.setAttribute('data-overlay','on'); }
  const sel=$('#arch-select'), frame=$('#arch-frame'), fade=$('#arch-fadeCover'); let current=0;
  function setSrcByIndex(idx){ if(!ARCH_LIST.length) return; const n=(idx+ARCH_LIST.length)%ARCH_LIST.length; current=n; sel.selectedIndex=n; const file=ARCH_LIST[n]+'.html'; fade?.classList.add('show'); setTimeout(()=>{ frame.src='./archetypes/'+file; forceOverlay(ARCH_LIST[n]); setTimeout(()=>fade&&fade.classList.remove('show'),180); try{ localStorage.setItem('uno:arch', ARCH_LIST[n]) }catch{}; showArchMessage('Arquétipo: '+ARCH_LIST[n]); },120); }
  function showArchMessage(t){ const el=$('#archMsg'); if(!el) return; el.textContent=t; el.classList.add('show'); clearTimeout(el._tm); el._tm=setTimeout(()=>el.classList.remove('show'),3200); }
  $('#arch-prev')?.addEventListener('click',()=>setSrcByIndex(current-1)); $('#arch-next')?.addEventListener('click',()=>setSrcByIndex(current+1)); sel?.addEventListener('change',()=>setSrcByIndex(sel.selectedIndex));
  (function bootArch(){ const saved=(localStorage.getItem('uno:arch')||'').toLowerCase(); const idx=Math.max(0,ARCH_LIST.indexOf(saved)); setSrcByIndex(idx); })();

  /* ===== Brain: Vozes (global + por arquétipo) ===== */
  function populateGlobalVoices(){ const voiceSel=$('#selectVoice'); if(!voiceSel) return; voiceSel.innerHTML=''; const voices=speechSynthesis.getVoices(); if(!voices.length){ voiceSel.innerHTML='<option>Vozes indisponíveis</option>'; return; } const filtered=voices.filter(v=>/^(pt|en)/i.test(v.lang||'')) || voices; const saved=localStorage.getItem('infodose:speechVoice')||''; filtered.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=v.name+' ('+v.lang+')'; if(saved && saved===v.name) o.selected=true; voiceSel.appendChild(o); }); }
  function initVoicesByArchetype(){ const wrap=$('#voicesWrap'); if(!wrap) return; wrap.innerHTML=''; const voices=speechSynthesis.getVoices(); const filtered=voices.filter(v=>/^(pt|en)/i.test(v.lang||'')) || voices; const saved=LS.get('infodose:voices',{}); ARCH_LIST.forEach(name=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.flexWrap='wrap'; const label=document.createElement('span'); label.style.minWidth='70px'; label.style.fontWeight='700'; label.textContent=name; const sel=document.createElement('select'); sel.className='btn'; sel.style.maxWidth='240px'; (filtered.length?filtered:voices).forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=v.name+' ('+v.lang+')'; sel.appendChild(o); }); if(saved[name]) sel.value=saved[name]; sel.onchange=()=>{ saved[name]=sel.value; LS.set('infodose:voices', saved); }; const test=document.createElement('button'); test.className='btn'; test.textContent='Teste'; test.onclick=()=>{ const u=new SpeechSynthesisUtterance(`Olá, eu sou ${name}`); const vn=saved[name]||sel.value; const v=(voices||[]).find(x=>x.name===vn); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u); }; row.append(label,sel,test); wrap.append(row); }); }
  function speakWithActiveArch(text){ try{ const arch=ARCH_LIST[current]; const saved=LS.get('infodose:voices',{}); const voices=speechSynthesis.getVoices(); let v=null; if(saved[arch]) v=voices.find(x=>x.name===saved[arch]); if(!v) v=voices.find(x=>/^(pt|en)/i.test(x.lang||''))||voices[0]; if(!v) return; const u=new SpeechSynthesisUtterance(text); u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{} }
  $('#saveVoice')?.addEventListener('click',()=>{ const sel=$('#selectVoice'); const v=sel?.value||''; if(v) localStorage.setItem('infodose:speechVoice', v); alert('Voz global salva: '+v); });
  $('#testVoice')?.addEventListener('click',()=>{ try{ const vname=localStorage.getItem('infodose:speechVoice'); const voices=speechSynthesis.getVoices(); const v=voices.find(x=>x.name===vname)||voices[0]; const u=new SpeechSynthesisUtterance('Teste de voz global.'); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{}});
  if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged=()=>{ populateGlobalVoices(); initVoicesByArchetype(); }; populateGlobalVoices(); initVoicesByArchetype(); }

  /* ===== Presets Visuais (envio para o iframe) ===== */
  function currentVisual(){ return { preset: LS.get('arch:visualPreset','blue1'), bloom: !!LS.get('arch:bloomOn',false), glow: Number(LS.get('arch:glowStrength',0.80)) } }
  function sendVisualToFrame(){ try{ const f=$('#arch-frame'); if(f&&f.contentWindow){ f.contentWindow.postMessage({ type:'visualSettings', data: currentVisual() }, '*'); } }catch{} }
  (function initVisual(){ const sel=$('#visualPreset'), chk=$('#bloomToggle'), rng=$('#glowRange'), out=$('#glowVal'), btnA=$('#applyVisual'), btnR=$('#resetVisual'); if(!sel||!chk||!rng||!out) return; sel.value=LS.get('arch:visualPreset','blue1'); chk.checked=!!LS.get('arch:bloomOn',false); rng.value=LS.get('arch:glowStrength',0.80); out.textContent=Number(rng.value).toFixed(2); rng.addEventListener('input',()=>out.textContent=Number(rng.value).toFixed(2)); btnA.addEventListener('click',()=>{ LS.set('arch:visualPreset', sel.value); LS.set('arch:bloomOn', !!chk.checked); LS.set('arch:glowStrength', Number(rng.value)); sendVisualToFrame(); }); btnR.addEventListener('click',()=>{ sel.value='blue1'; chk.checked=false; rng.value=0.80; out.textContent='0.80'; LS.set('arch:visualPreset','blue1'); LS.set('arch:bloomOn', false); LS.set('arch:glowStrength', 0.80); sendVisualToFrame(); }); })();
  $('#arch-frame')?.addEventListener('load', ()=> setTimeout(sendVisualToFrame,120));

  /* ===== UI Theme (Blue‑1) ===== */
  function applyUITheme(v){ if(v==='blue1'){ document.body.setAttribute('data-theme','blue1'); } else { document.body.removeAttribute('data-theme'); } }
  (function initUITheme(){ const sel=document.getElementById('uiThemeSelect'); if(!sel) return; const saved=localStorage.getItem('uno:uiTheme')||'default'; sel.value=saved; applyUITheme(saved); sel.addEventListener('change', ()=>{ const v=sel.value; localStorage.setItem('uno:uiTheme', v); applyUITheme(v); }); })();

  /* ===== Mini Audio Meter (mic) ===== */
  (function audioMeter(){ const meter=document.getElementById('audioMeter'); if(!meter) return; const bar=meter.querySelector('.bar'); let ctx=null, analyser=null, stream=null, raf=null, on=false; async function start(){ try{ stream=await navigator.mediaDevices.getUserMedia({audio:true}); ctx=new (window.AudioContext||window.webkitAudioContext)(); const src=ctx.createMediaStreamSource(stream); analyser=ctx.createAnalyser(); analyser.fftSize=256; src.connect(analyser); meter.classList.add('on'); on=true; tick(); }catch(e){ alert('Microfone bloqueado.'); stop(); } } function stop(){ meter.classList.remove('on'); on=false; if(raf) cancelAnimationFrame(raf); if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } if(ctx){ try{ ctx.close(); }catch{} ctx=null; } if(bar) bar.style.height='20%'; } function tick(){ if(!analyser) return; const buf=new Uint8Array(analyser.fftSize); analyser.getByteTimeDomainData(buf); let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; } const rms=Math.sqrt(sum/buf.length); const h=Math.max(18, Math.min(100, Math.round(rms*240))); bar.style.height=h+'%'; raf=requestAnimationFrame(tick); } window.__stopAudioMeter = stop; window.__startAudioMeter = start;
    meter.addEventListener('click', ()=>{ on?stop():start(); }, {passive:true}); })();

  /* ===== Splash hide (robusto) ===== */
  (function bootSplash(){
    var sp = document.getElementById('appSplash');
    if(!sp) return;
    var done = false; var tidFallback;
    function hideSplash(reason){
      if(done) return; done = true;
      try{ sp.classList.add('hidden'); }catch(e){}
      try{ setTimeout(function(){ if(sp && sp.parentNode){ sp.parentNode.removeChild(sp); } }, 500); }catch(e){}
      try{ if(tidFallback) clearTimeout(tidFallback); }catch(e){}
      try{ console.debug('[UNO] splash hide:', reason); }catch(e){}
    }
    if(document.readyState === 'complete') setTimeout(function(){ hideSplash('ready-complete'); }, 200);
    window.addEventListener('load', function(){ setTimeout(function(){ hideSplash('window-load'); }, 200); }, { once:true });
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ hideSplash('domcontentloaded'); }, 600); }, { once:true });
    window.addEventListener('pageshow', function(){ setTimeout(function(){ hideSplash('pageshow'); }, 200); }, { once:true });
    // Fallback absoluto
    tidFallback = setTimeout(function(){ hideSplash('fallback-3s'); }, 3000);
    // Quando o iframe do arquétipo carregar
    var fr = document.getElementById('arch-frame');
    if(fr){ fr.addEventListener('load', function(){ setTimeout(function(){ hideSplash('arch-frame-load'); }, 200); }, { once:true }); }
    // Primeira interação do usuário
    ['click','touchstart','keydown'].forEach(function(ev){ window.addEventListener(ev, function(){ hideSplash('first-interaction'); }, { once:true, passive:true }); });
    // Em caso de erro global, não travar a tela
    window.addEventListener('error', function(){ hideSplash('onerror'); }, { once:true });
  })();

  /* ===== Restaurar última aba ===== */
  (function(){ const last=localStorage.getItem('uno:lastTab')||'home'; nav(last); })();

  /* ===== Stack (HDPro): grupos/sessões + persistência ===== */
  const stackWrap=$('#stackWrap'), dock=$('#dock');
  function badge(item){ const b=document.createElement('button'); b.className='badge fx-trans fx-press'; b.textContent=item.title||'App'; b.title='Reabrir '+(item.title||'App'); b.addEventListener('click',()=>{ const s=document.querySelector('[data-sid="'+item.sid+'"]'); if(s){ s.scrollIntoView({behavior:'smooth'}); s.classList.remove('min'); } }); return b }
  function updateDock(){ dock.innerHTML=''; $$('.session').forEach(s=>{ const meta=JSON.parse(s.dataset.meta||'{}'); dock.appendChild(badge({title: meta.title||'Sessão', sid:s.dataset.sid})); }); }
  function saveStackState(){ try{ const groups=[]; document.querySelectorAll('#stackWrap .stack-group').forEach(g=>{ const id=g.getAttribute('data-group-id'); const name=g.querySelector('summary')?.textContent||''; if(id&&name) groups.push({id,name}); }); localStorage.setItem('unoStackGroups', JSON.stringify(groups)); const sess=[]; document.querySelectorAll('#stackWrap .session').forEach(card=>{ const sid=card.dataset.sid; const meta=card.dataset.meta; const gid=card.dataset.gid||null; const min=card.classList.contains('min'); if(sid&&meta) sess.push({sid,meta,gid,min}); }); localStorage.setItem('unoStackSessions', JSON.stringify(sess)); }catch(e){ console.warn('saveStackState',e); } }
  window.saveStackState=saveStackState;
  function createStackGroup(gid,name){ const details=document.createElement('details'); details.className='stack-group'; details.setAttribute('data-group-id', gid); details.open=true; const summary=document.createElement('summary'); summary.textContent=name; const content=document.createElement('div'); content.className='group-content'; details.append(summary,content); stackWrap.prepend(details); return details }
  function ensureDefaultGroup(){ if(!document.querySelector('#stackWrap .stack-group')) createStackGroup('g_default','Grupo'); }
  function openApp(a){ const sid=a.sid||('s_'+Math.random().toString(36).slice(2)); const isLocal=String(a.url||'').startsWith('local:'); const lr=isLocal? getLocal(String(a.url).slice(6)) : null; const url=lr? blobURL(lr): (a.url||'about:blank'); const card=document.createElement('div'); card.className='session fx-trans'; card.dataset.sid=sid; card.dataset.meta=JSON.stringify({title:a.title||'App', url:a.url||''}); if(a.gid) card.dataset.gid=a.gid; card.innerHTML=`
      <div class="hdr">
        <div class="title">${a.title||'App'}</div>
        <div class="tools">
          <button class="btn" data-act="min" title="Min">−</button>
          <button class="btn" data-act="ref" title="Recarregar">↻</button>
          <button class="btn" data-act="full" title="Tela cheia">⤢</button>
          <button class="btn" data-act="close" title="Fechar">×</button>
        </div>
      </div>
      <iframe src="${url}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>`;
    const gid=a.gid; let placed=false; if(gid){ const grp=stackWrap.querySelector('.stack-group[data-group-id="'+gid+'"] .group-content'); if(grp){ grp.prepend(card); placed=true; } }
    if(!placed){ ensureDefaultGroup(); stackWrap.querySelector('.stack-group .group-content').prepend(card); }
    // attach group dropdown
    ensureGroupSelect(card);
    card.querySelector('[data-act=min]').onclick=()=>{ card.classList.toggle('min'); refreshGroupSelects(); updateDock(); saveStackState(); };
    card.querySelector('[data-act=ref]').onclick=()=>{ const fr=card.querySelector('iframe'); try{ fr.contentWindow.location.reload() }catch{ fr.src=fr.src } };
    card.querySelector('[data-act=full]').onclick=()=>{ card.classList.toggle('full'); };
    card.querySelector('[data-act=close]').onclick=()=>{ card.remove(); updateDock(); saveStackState(); };
    updateDock(); saveStackState(); }
  function getLocal(id){ let arr=[]; try{ arr=JSON.parse(LS.raw('infodose:locals:v1')||'[]') }catch{} return arr.find(x=>x.id===id)||null }
  function blobURL(local){ const blob=new Blob([local.html||''],{type:'text/html;charset=utf-8'}); return URL.createObjectURL(blob) }
  function restoreStackState(){ try{ const groups=JSON.parse(localStorage.getItem('unoStackGroups')||'[]'); if(Array.isArray(groups)) groups.forEach(g=>g&&g.id&&g.name&&createStackGroup(g.id,g.name)); const sessions=JSON.parse(localStorage.getItem('unoStackSessions')||'[]'); if(Array.isArray(sessions)) sessions.forEach(s=>{ try{ const meta=JSON.parse(s.meta||'{}'); openApp({sid:s.sid,title:meta.title,url:meta.url,gid:s.gid}); const card=document.querySelector('[data-sid="'+s.sid+'"]'); if(card && s.min) card.classList.add('min'); }catch(e){} }); }catch(e){ console.warn('restoreStackState',e); } updateDock(); }
  window.restoreStackState=restoreStackState;
  $('#btnCloseAll')?.addEventListener('click',()=>{ if(!confirm('Fechar todas as sessões?')) return; $$('.session').forEach(s=>s.remove()); updateDock(); saveStackState(); refreshGroupSelects(); });
  $('#btnAddGroup')?.addEventListener('click',()=>{ const name=prompt('Nome do grupo:'); if(!name) return; const gid='g_'+Math.random().toString(36).slice(2); createStackGroup(gid,name); saveStackState(); refreshGroupSelects(); });
  $('#btnStackUpload')?.addEventListener('click',()=>$('#stackUpload')?.click());
  $('#stackUpload')?.addEventListener('change',(ev)=>{ const file=ev.target.files&&ev.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ const content=String(r.result||''); const blob=new Blob([content],{type:'text/html'}); const url=URL.createObjectURL(blob); openApp({ title:file.name.replace(/\.(html?|txt)$/i,''), url }); }; r.readAsText(file); ev.target.value=''; });
  restoreStackState(); refreshGroupSelects();

  /* ===== LS Panel (escopado + Self‑test) ===== */
  function pretty(n){ if(!Number.isFinite(n)||n<=0) return '0 B'; const u=['B','KB','MB','GB']; let i=0; while(n>=1024&&i<u.length-1){ n/=1024; i++ } return n.toFixed(i?1:0)+' '+u[i] }
  function sizeLS(){ let sum=0; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; sum+=(k.length+v.length)*2 } return sum }
  function inferType(v){
    if(v==null||v==='') return 'empty';
    try{
      const p=JSON.parse(v);
      return Array.isArray(p) ? 'json[array]' : (p && typeof p==='object' ? 'json[object]' : 'json['+typeof p+']');
    }catch{}
    if(/^data:image\//i.test(v) || /\.(png|jpe?g|gif|webp|svg)(\?|$)/i.test(v)) return 'image';
    if(/^(true|false|1|0)$/i.test(v)) return 'boolean-like';
    if(/^https?:\/\//i.test(v)) return 'url';
    return 'string'
  }
  function renderLS(){ const list=$('#lsList'), meta=$('#lsMeta'); if(!list) return; list.innerHTML=''; const count=localStorage.length; const bytes=sizeLS(); if(meta) meta.textContent=count+' chave(s) • '+pretty(bytes); const entries=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); const v=localStorage.getItem(k)||''; entries.push({k,v}) } entries.sort((a,b)=>a.k.localeCompare(b.k)); entries.forEach(({k,v})=>{ const item=document.createElement('div'); item.style.display='grid'; item.style.gridTemplateColumns='1fr auto'; item.style.gap='8px'; item.style.alignItems='start'; item.style.border='1px solid rgba(255,255,255,.12)'; item.style.borderRadius='12px'; item.style.background='rgba(255,255,255,.04)'; item.style.padding='8px'; const left=document.createElement('div'); left.innerHTML='<div style="font-weight:800">'+k+'</div><div class="mut">'+inferType(v)+' • '+pretty((k.length+v.length)*2)+'</div>'; const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px'; right.style.flexWrap='wrap'; const bEdit=document.createElement('button'); bEdit.className='btn'; bEdit.textContent='Editar'; bEdit.onclick=()=>{ const next=prompt('Editar valor de\n'+k, v); if(next==null) return; try{ localStorage.setItem(k, String(next)); renderLS(); }catch(e){ alert('Falha ao salvar'); } }; const bDel=document.createElement('button'); bDel.className='btn'; bDel.textContent='Apagar'; bDel.onclick=()=>{ if(confirm('Apagar '+k+'?')){ localStorage.removeItem(k); renderLS(); } }; const val=document.createElement('div'); val.style.font='12px/1.4 ui-monospace,monospace'; val.style.background='#0b0f1a'; val.style.border='1px solid rgba(255,255,255,.12)'; val.style.borderRadius='10px'; val.style.padding='8px'; val.style.maxHeight='140px'; val.style.overflow='auto'; val.style.wordBreak='break-word'; val.textContent=v; right.append(bEdit,bDel); item.append(left,right,val); list.append(item); }); }
  function openLS(){ const m=$('#lsModal'); if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); renderLS(); } }
  function closeLS(){ const m=$('#lsModal'); if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); } }
  $('#btnLS')?.addEventListener('click',(ev)=>{ ev.preventDefault(); openLS(); },{passive:false});
  $('#lsClose')?.addEventListener('click', closeLS);
  $('#lsRescan')?.addEventListener('click', renderLS);
  $('#lsExport')?.addEventListener('click', ()=>{ const dump={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); dump[k]=localStorage.getItem(k); } const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='localstorage_export.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); });
  $('#lsImportFile')?.addEventListener('change',(ev)=>{ const f=ev.target.files&&ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(String(r.result||'{}')); Object.entries(obj).forEach(([k,v])=> localStorage.setItem(k, String(v))); alert('Importado.'); renderLS(); }catch{ alert('JSON inválido.'); } }; r.readAsText(f); ev.target.value=''; });
  $('#lsClearAll')?.addEventListener('click', ()=>{ if(!confirm('Limpar chaves Infodose (infodose:*, dual.*)?')) return; try{ const toRemove=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && (k.startsWith('infodose:')||k.startsWith('dual.'))) toRemove.push(k); } toRemove.forEach(k=> localStorage.removeItem(k)); renderLS(); alert('Removidas '+toRemove.length+' chave(s) Infodose.'); }catch(e){ alert('Falha ao limpar: '+e.message); } });

  /* ===== Self‑test (dentro do LS Panel) ===== */
  function selfLog(msg){ const box=$('#selfLog'); if(box){ const line=document.createElement('div'); line.textContent=msg; box.appendChild(line); } }
  function runSelfTest(){ $('#selfLog').innerHTML=''; try{
    const t1 = !!$('#arch-select') && $('#arch-select').options.length===12; selfLog('T1 arch-select (12): '+(t1?'PASS':'FAIL'));
    const t2 = !!$('#arch-frame'); selfLog('T2 arch-frame exists: '+(t2?'PASS':'FAIL'));
    const t3 = !!$('#overlay-unificado'); selfLog('T3 overlay style: '+(t3?'PASS':'FAIL'));
    const t4 = (document.documentElement.getAttribute('data-overlay')||'on')==='on'; selfLog('T4 overlay forced on: '+(t4?'PASS':'FAIL'));
    setTimeout(()=>{ const splashGone=!$('#appSplash'); selfLog('T5 splash hidden: '+(splashGone?'PASS':'WARN')); }, 1400);
    const t6 = typeof saveStackState==='function' && typeof restoreStackState==='function' ; selfLog('T6 stack persist fns: '+(t6?'PASS':'FAIL'));
    let cand=0; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i)||''; if(k.startsWith('infodose:')||k.startsWith('dual.')) cand++; }
    selfLog('T7 scoped keys (infodose:/dual.): '+cand);
    const t8 = 'speechSynthesis' in window; selfLog('T8 speech synthesis: '+(t8?'PASS':'WARN'));
    const v = currentVisual(); selfLog('T9 visual preset: '+JSON.stringify(v));
    const theme = document.body.getAttribute('data-theme')||'default'; selfLog('T10 UI theme: '+theme);
    const anySess = !!document.querySelector('#stackWrap .session');
    const hasSel = anySess ? !!document.querySelector('#stackWrap .session .group-select') : true; selfLog('T11 group dropdown present: '+(hasSel?'PASS':'WARN'));
    // Extra unit-like tests for inferType
    try{
      const i1 = inferType('data:image/png;base64,AA')==='image';
      const i2 = inferType('foto.webp')==='image';
      const i3 = inferType('TRUE')==='boolean-like';
      const i4 = inferType('https://exemplo.com')==='url';
      selfLog('T12 inferType image(data:): '+(i1?'PASS':'FAIL'));
      selfLog('T13 inferType image(ext): '+(i2?'PASS':'FAIL'));
      selfLog('T14 inferType boolean-like: '+(i3?'PASS':'FAIL'));
      selfLog('T15 inferType url: '+(i4?'PASS':'FAIL'));
    }catch(e){ selfLog('T12–T15 inferType tests error: '+e.message); }
  }catch(e){ selfLog('Self-test error: '+e.message); } }
  $('#runSelfTest')?.addEventListener('click', runSelfTest);

  /* ===== Grupos / mover sessão ===== */
  function listGroups(){ return Array.from(document.querySelectorAll('#stackWrap .stack-group')).map(g=>({ id:g.getAttribute('data-group-id'), name:g.querySelector('summary')?.textContent||'' })).filter(x=>x.id&&x.name); }
  function refreshGroupSelectOptions(selectEl, currentGid){ const groups=listGroups(); selectEl.innerHTML=''; const optRoot=document.createElement('option'); optRoot.value='__root__'; optRoot.textContent='Sem grupo'; selectEl.appendChild(optRoot); groups.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; selectEl.appendChild(o); }); selectEl.value=currentGid || '__root__'; }
  function ensureGroupSelect(card){ let sel=card.querySelector('.group-select'); if(!sel){ sel=document.createElement('select'); sel.className='group-select btn'; sel.title='Mover para grupo'; const tools=card.querySelector('.tools'); tools && tools.insertBefore(sel, tools.firstChild); sel.addEventListener('change', ()=>{ const gid=sel.value; moveSessionTo(card, gid==='__root__'? null: gid); }); } refreshGroupSelectOptions(sel, card.dataset.gid||null); }
  function refreshGroupSelects(){ document.querySelectorAll('#stackWrap .session').forEach(ensureGroupSelect); }
  function moveSessionTo(card, gid){ if(gid){ const grp=document.querySelector('#stackWrap .stack-group[data-group-id="'+gid+'"] .group-content'); if(grp){ grp.prepend(card); card.dataset.gid=gid; } } else { stackWrap.prepend(card); delete card.dataset.gid; } refreshGroupSelects(); updateDock(); saveStackState(); }
  document.getElementById('btnRenameGroup')?.addEventListener('click', ()=>{ const groups=listGroups(); if(!groups.length){ alert('Nenhum grupo. Crie um antes.'); return; } const names=groups.map((g,i)=> `${i+1}. ${g.name}`).join('\n'); const idxStr=prompt('Qual grupo renomear?\n'+names); if(!idxStr) return; const i=parseInt(idxStr,10)-1; if(isNaN(i)||i<0||i>=groups.length) return; const newName=prompt('Novo nome para '+groups[i].name+':'); if(!newName) return; const node=document.querySelector('#stackWrap .stack-group[data-group-id="'+groups[i].id+'"] summary'); if(node){ node.textContent=newName; saveStackState(); refreshGroupSelects(); } });
  
  // ===== Toast + Chat Rápido (Apps) + Descarregador de Segurança =====
  (function initToast(){
    if(document.getElementById('toastBox')) return;
    const box=document.createElement('div'); box.id='toastBox';
    box.style.cssText='position:fixed;right:14px;bottom:calc(var(--tabsH) + 16px);display:grid;gap:8px;z-index:2000';
    document.body.appendChild(box);
    window.toast=function(msg){ const el=document.createElement('div'); el.style.cssText='background:rgba(15,17,32,.92);border:1px solid rgba(255,255,255,.18);color:var(--fg);padding:.6rem .8rem;border-radius:12px;box-shadow:var(--shadow);font-weight:800'; el.textContent=msg; box.appendChild(el); setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(),220); }, 1800); };
  })();
  (function welcomeToast(){ try{ const name=(localStorage.getItem('infodose:userName')||'').trim(); if(name){ toast('Bem-vindo, '+name+'. UNO está ao seu lado.'); } else { toast('Salve! Configure seu nome no Brain.'); } }catch{} })();

  function pushChat(type, text){ const feed=document.getElementById('chatFeed'); if(!feed) return; const div=document.createElement('div'); div.className='msg '+(type==='user'?'user':'ai'); div.textContent=text; feed.appendChild(div); feed.scrollTop=feed.scrollHeight; }
  function quickSend(msg){ const t=String(msg||'').trim(); if(!t) return; pushChat('user','Você: '+t); try{ showArchMessage && showArchMessage('Pulso enviado. Recebendo intenção…'); }catch{} setTimeout(()=>{ const reply='Recebido.'; pushChat('ai', reply); try{ speakWithActiveArch && speakWithActiveArch(reply); }catch{} }, 200); }
  (function bindAppsChat(){ const form=document.getElementById('appsChatForm'); const inp=document.getElementById('appsChatInput'); const voice=document.getElementById('appsVoiceBtn'); const qText=document.getElementById('appsQuickText'); const qVoice=document.getElementById('appsQuickVoice'); if(form&&inp){ form.addEventListener('submit', (e)=>{ e.preventDefault(); const v=inp.value.trim(); inp.value=''; quickSend(v); }); }
    function startAppsSpeech(){ try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('Reconhecimento de fala não suportado'); return; } const r=new SR(); r.lang='pt-BR'; r.interimResults=false; r.maxAlternatives=1; r.onresult=(ev)=>{ const t=ev.results[0][0].transcript.trim(); quickSend(t); }; r.onerror=()=>toast('Falha no reconhecimento'); r.start(); }catch(e){ toast('Falha de áudio'); } }
    voice&&voice.addEventListener('click', startAppsSpeech); qText&&qText.addEventListener('click', ()=>{ try{ document.getElementById('appsChatInput')?.focus(); }catch{} }); qVoice&&qVoice.addEventListener('click', startAppsSpeech);
  })();

  async function unloadSafe(){ try{ speechSynthesis && speechSynthesis.cancel(); }catch{} try{ window.__stopAudioMeter && window.__stopAudioMeter(); }catch{} try{ document.querySelectorAll('video,audio').forEach(m=>{ try{ m.pause(); m.srcObject && m.srcObject.getTracks().forEach(t=>t.stop()); }catch{} }); }catch{}
    try{ document.querySelectorAll('iframe').forEach(fr=>{ try{ const src=fr.src||''; if(src.startsWith('blob:')) URL.revokeObjectURL(src); fr.src='about:blank'; }catch{} }); }catch{}
    try{ document.querySelectorAll('#stackWrap .session').forEach(s=> s.remove()); updateDock && updateDock(); saveStackState && saveStackState(); }catch{}
    if('serviceWorker' in navigator){ try{ const regs=await navigator.serviceWorker.getRegistrations(); for(const reg of regs){ try{ await reg.unregister(); }catch{} } }catch{} }
    toast('Sistema descarregado com segurança.');
  }
  document.getElementById('btnUnloadSafe')?.addEventListener('click', unloadSafe);

</script>
  
  <!-- LS PANEL OVERRIDE (JS) -->
  <script id="LSPANEL_OVERRIDE_JS">
(function(){
  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const DISABLED_KEY='uno:ls.disabled';
  function getDisabled(){ try{ return new Set(JSON.parse(localStorage.getItem(DISABLED_KEY)||'[]')); }catch{ return new Set(); } }
  function setDisabled(set){ try{ localStorage.setItem(DISABLED_KEY, JSON.stringify(Array.from(set))); }catch{} }

  let SNAP=null; // snapshot inicial para diff
  function snapshotLS(){ const m={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); m[k]=localStorage.getItem(k); } return m }
  function diffLS(){ const now=snapshotLS(); const base=SNAP||{}; const added=[]; const removed=[]; const changed=[];
    Object.keys(now).forEach(k=>{ if(!(k in base)) added.push(k); else if(now[k]!==base[k]) changed.push(k); });
    Object.keys(base).forEach(k=>{ if(!(k in now)) removed.push(k); });
    return {added,removed,changed, nowCount:Object.keys(now).length };
  }

  function ensureToolbar(){
    const panel=$('#lsModal .panel'); if(!panel) return;
    if($('#lsToolbar')) return;
    const toolbar=document.createElement('div'); toolbar.id='lsToolbar';
    toolbar.innerHTML=`
      <input id="lsSearch" placeholder="Buscar chave/valor…" />
      <select id=\"lsSort\">
        <option value=\"key\">Ordenar: Chave A→Z</option>
        <option value=\"keyz\">Ordenar: Chave Z→A</option>
        <option value=\"size\">Ordenar: Maior tamanho</option>
      </select>
      <button class=\"ls-chip\" data-prefix=\"infodose:\">infodose:</button>
      <button class=\"ls-chip\" data-prefix=\"dual.\">dual.</button>
      <button class=\"ls-chip\" data-prefix=\"uno:\">uno:</button>
      <button id=\"lsExportFiltered\" class=\"ls-chip\" title=\"Exportar apenas prefixos ativos\">Exportar (prefixos)</button>
      <button id=\"lsDevToggle\" class=\"ls-chip\" title=\"Modo developer: diffs e operações avançadas\">Dev</button>
      <button id=\"lsClearDisabled\" class=\"ls-chip\" title=\"Apagar chaves marcadas como desativadas\">Clear disabled</button>
    `;
    const meta=$('#lsMeta'); (meta?.parentNode||panel).insertBefore(toolbar, meta?.nextSibling||panel.firstChild);

    // painel dev
    const dev=document.createElement('div'); dev.id='lsDevPanel'; dev.style.display='none';
    dev.innerHTML=`
      <div style=\"font-weight:800;margin:4px 0 8px\">Developer</div>
      <div id=\"lsDiffWrap\" class=\"grid\"></div>
    `;
    panel.appendChild(dev);

    SNAP = snapshotLS();
    bindToolbar(); decorateList(); renderDiff();
  }

  function bytesOf(k,v){ return 2*((k||'').length + (v||'').length); }
  function decorateList(){
    const list=$('#lsList'); if(!list) return; $$('.ls-copy,.ls-disable', list).forEach(b=>b.remove());
    const disabled=getDisabled();
    list.querySelectorAll('.item').forEach(it=>{
      // heurística para encontrar chave/valor
      const head = it.querySelector('div');
      const firstLine = head?.textContent?.split('
')[0]?.trim()||'';
      const key = firstLine || it.querySelector('.key')?.textContent || '';
      const valEl=it.querySelector('.val'); const v=valEl? valEl.textContent: '';
      const bar=document.createElement('div'); bar.style.display='flex'; bar.style.gap='6px'; bar.style.flexWrap='wrap'; bar.style.marginTop='6px';
      const b1=document.createElement('button'); b1.className='ls-copy'; b1.textContent='Copiar chave'; b1.onclick=()=>copyText(key);
      const b2=document.createElement('button'); b2.className='ls-copy'; b2.textContent='Copiar valor'; b2.onclick=()=>copyText(v);
      const b3=document.createElement('button'); b3.className='ls-disable'; b3.textContent = disabled.has(key)? 'Ativar':'Desativar';
      b3.onclick=()=>{ const d=getDisabled(); if(d.has(key)) d.delete(key); else d.add(key); setDisabled(d); b3.textContent=d.has(key)?'Ativar':'Desativar'; applyFilters(); };
      bar.append(b1,b2,b3); valEl && valEl.appendChild(bar);
    });
    applyFilters();
  }

  function copyText(t){ try{ navigator.clipboard.writeText(String(t||'')); window.toast && toast('Copiado.'); }catch{}}

  function bindToolbar(){
    const search=$('#lsSearch'); const sort=$('#lsSort');
    const chips=$$('.ls-chip');
    chips.forEach(c=> c.addEventListener('click', (ev)=>{
      const id=c.id||'';
      if(id==='lsExportFiltered'){ return exportFiltered(); }
      if(id==='lsDevToggle'){ c.classList.toggle('on'); const show=c.classList.contains('on'); $('#lsDevPanel').style.display = show? 'block':'none'; renderDiff(); return; }
      if(id==='lsClearDisabled'){ return clearDisabledKeys(); }
      c.classList.toggle('on'); applyFilters();
    }));
    search?.addEventListener('input', applyFilters);
    sort?.addEventListener('change', applyFilters);
  }

  function exportFiltered(){
    const prefixes=$$('.ls-chip.on').map(c=> c.getAttribute('data-prefix')).filter(Boolean);
    if(!prefixes.length){ window.toast && toast('Selecione ao menos um prefixo.'); return; }
    const dump={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i); if(prefixes.some(p=> k.startsWith(p))) dump[k]=localStorage.getItem(k);
    }
    const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='localstorage_export_prefixes.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
    window.toast && toast('Exportado ('+Object.keys(dump).length+' chaves).');
  }

  function clearDisabledKeys(){
    const d=getDisabled(); if(!d.size){ window.toast && toast('Não há chaves desativadas.'); return; }
    if(!confirm('Apagar todas as chaves desativadas? ('+d.size+')')) return;
    let n=0; d.forEach(k=>{ try{ localStorage.removeItem(k); n++; }catch{} });
    setDisabled(new Set());
    // re-render
    const r = $('#lsRescan'); r && r.click();
    window.toast && toast('Removidas '+n+' chaves.');
  }

  function applyFilters(){
    const list=$('#lsList'); if(!list) return;
    const q=($('#lsSearch')?.value||'').toLowerCase();
    const sort=$('#lsSort')?.value||'key';
    const prefixes=$$('.ls-chip.on').map(c=> c.getAttribute('data-prefix')).filter(Boolean);
    const dset=getDisabled();
    const items=[...list.querySelectorAll('.item')].map(it=>{
      const head=it.querySelector('div'); const key=(head?.textContent?.split('
')[0]?.trim()||'');
      const val=it.querySelector('.val')?.textContent||''; return {it,key,val,size:bytesOf(key,val)};
    });
    items.forEach(({it})=> it.classList.remove('ls-item-highlight'));
    items.forEach(({it,key,val})=>{
      const matchQ=!q || (key.toLowerCase().includes(q) || val.toLowerCase().includes(q));
      const matchP=!prefixes.length || prefixes.some(p=> key.startsWith(p));
      const notDisabled=!dset.has(key);
      it.style.display = (matchQ && matchP && notDisabled)? 'grid':'none';
      if(q && matchQ) it.classList.add('ls-item-highlight');
    });
    const visible = items.filter(x=> x.it.style.display!=='none');
    visible.sort((a,b)=>{ if(sort==='size') return b.size-a.size; if(sort==='keyz') return b.key.localeCompare(a.key); return a.key.localeCompare(b.key); });
    visible.forEach(({it})=> list.appendChild(it));
  }

  function renderDiff(){
    const dev=$('#lsDevPanel'); if(!dev || getComputedStyle(dev).display==='none') return;
    const wrap=$('#lsDiffWrap'); if(!wrap) return; wrap.innerHTML='';
    const d=diffLS();
    const mk=(title, arr, color)=>{
      const box=document.createElement('div');
      box.innerHTML = `<div class="mut" style="margin-bottom:6px">${title} <strong>(${arr.length})</strong></div>`;
      if(!arr.length){ const p=document.createElement('div'); p.className='pill'; p.textContent='—'; box.appendChild(p); wrap.appendChild(box); return; }
      arr.slice(0,50).forEach(k=>{ const p=document.createElement('div'); p.className='pill'; p.style.borderColor=color; p.textContent=k; box.appendChild(p); });
      if(arr.length>50){ const more=document.createElement('div'); more.className='pill'; more.textContent = '+ '+(arr.length-50)+' mais'; box.appendChild(more); }
      wrap.appendChild(box);
    };
    mk('Adicionadas', d.added, 'rgba(57,255,182,.45)');
    mk('Removidas', d.removed, 'rgba(255,107,107,.45)');
    mk('Alteradas', d.changed, 'rgba(255,184,107,.45)');
  }

  function onOpen(){ setTimeout(()=>{ ensureToolbar(); decorateList(); renderDiff(); }, 30); }
  // Hook de abertura
  const btn=document.getElementById('btnLS'); btn&&btn.addEventListener('click', onOpen, {passive:true});
  // Observa mudanças no modal
  const obs=new MutationObserver(()=>{ const open=getComputedStyle(document.getElementById('lsModal')||{}).display!=='none'; if(open) onOpen(); });
  document.addEventListener('DOMContentLoaded', ()=>{ const m=document.getElementById('lsModal'); if(m) obs.observe(m, {attributes:true, attributeFilter:['style','class']}); });
})();
</script>
</body>
</html>
